#!/usr/bin/env bash

src_node=$1
tgt_node_nbr=$2
tgt_host="hf1"

base_node="$tgt_host:z10"
base_snap="base-2020-05-26-2"
base_ip="2a01:4f9:4a:5501::10"
tgt_ip="2a01:4f9:4a:5501::$tgt_node_nbr"
tgt_node="$tgt_host:z$tgt_node_nbr"

echo check if target exists
if [[ $(lxc list "$tgt_node" -cn --format csv) == "z$tgt_node_nbr" ]]; then
  echo target $tgt_node exists, abort
  exit
fi

echo copy base to target
lxc copy "$base_node/$base_snap" "$tgt_node"

echo fix target network config
net_cfg=$(lxc config get "$tgt_node" user.network-config | sed s/$base_ip/$tgt_ip/)
lxc config set "$tgt_node" user.network-config "$net_cfg"

echo update IP in zen.conf
workdir=$(mktemp -d)
mkdir -p "$workdir"
lxc file pull "$tgt_node/home/zen/.zen/zen.conf" "$workdir/zen.conf"
sed -i s/$base_ip/$tgt_ip/ "$workdir/zen.conf"
lxc file push "$workdir/zen.conf" "$tgt_node/home/zen/.zen/zen.conf"

echo get wallet and config from $src_node
scp -T "zen@$src_node:{.zen/wallet.dat,secnodetracker/config/config.json}" "$workdir/"
echo use jq to override fqdn and ipv6 in config json
fqdn="$tgt_host-z$tgt_node_nbr.nodelauncher.com"
jq_expr='.secure.fqdn=$fqdn | .secure.ipv="6" | .secure.home="ts5.eu" | .secure.region="eu"' 
jq --arg fqdn "$fqdn" "$jq_expr" "$workdir/"config.json > "$workdir/tgtcfg.json"

echo push modified config json to target $tgt_node
lxc file push "$workdir/tgtcfg.json" "$tgt_node/home/zen/secnodetracker/config/config.json"
echo push wallet to target $tgt_node
lxc file push "$workdir/wallet.dat" "$tgt_node/home/zen/.zen/wallet.dat"
echo boot target node $tgt_node
lxc start "$tgt_node"
echo stop and disable on source $src_node
sleep 10
ssh "$src_node" "sudo systemctl stop zentracker && sudo systemctl disable zentracker"
ssh -o StrictHostKeyChecking=accept-new "$fqdn" "sudo chown zen:zen /home/zen/{.zen/wallet.dat,.zen/zen.conf,secnodetracker/config/config.json} && sudo systemctl restart zend zentracker"
