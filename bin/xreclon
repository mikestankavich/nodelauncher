#!/usr/bin/env bash

# re-clone specified node from baseline node z10 to recover disk space


tgt_node=$1
tgt_host="hf1"

clon_src="$tgt_host:z10/base-2021-11-27"

if [[ $(lxc list "$tgt_host:$tgt_node" -cn --format csv | head -1) == "$tgt_node" ]]; then
  echo target $tgt_node exists, here we go...
else
  echo target $tgt_node does not exist - abort
  exit
fi

echo "stop $tgt_node"
lxc stop "$tgt_host:$tgt_node"

echo make a working directory
workdir=$(mktemp -d)
mkdir -p "$workdir"
echo copy config and wallet files
lxc file pull "$tgt_host:$tgt_node/home/zen/.zen/zen.conf" "$workdir/"
lxc file pull "$tgt_host:$tgt_node/home/zen/.zen/wallet.dat" "$workdir/"
lxc file pull "$tgt_host:$tgt_node/home/zen/secnodetracker/config/config.json" "$workdir/"

echo "get $tgt_node network config"
net_cfg=$(lxc config get "$tgt_host:$tgt_node" user.network-config)

echo get first profile name
profile_name=$(lxc config show "$tgt_host:$tgt_node" | grep -A1 profiles | awk 'NR==2{print $2}')

echo "rename $tgt_node to $tgt_node-reclon"
lxc rename "$tgt_host:$tgt_node" "$tgt_node-reclon" 

echo copy base to target
lxc copy "$clon_src" "$tgt_host:$tgt_node"

echo push config files
lxc file push "$workdir/zen.conf" "$tgt_host:$tgt_node/home/zen/.zen/"
lxc file push "$workdir/wallet.dat" "$tgt_host:$tgt_node/home/zen/.zen/"
lxc file push "$workdir/config.json" "$tgt_host:$tgt_node/home/zen/secnodetracker/config/"

echo assign profile
lxc profile assign "$tgt_host:$tgt_node" "$profile_name"

echo push target network config
lxc config set "$tgt_host:$tgt_node" user.network-config "$net_cfg"

lxc start "$tgt_host:$tgt_node"
sleep 3
node_files="/home/zen/{.zen/zen.conf,.zen/wallet.dat,secnodetracker/config/config.json}"
post_cmds="sudo chown zen:zen $node_files && sudo systemctl restart zend"

echo ssh -o StrictHostKeyChecking=accept-new "$tgt_host-$tgt_node" "$post_cmds"

ssh-keygen -R "$tgt_host-$tgt_node"
ssh-keygen -R $(lxc list -c4 --format csv "$tgt_host:$tgt_node" | awk 'NR==1{print $1}')
ssh-keygen -R $(lxc list -c6 --format csv "$tgt_host:$tgt_node" | awk 'NR==1{print $1}')

until ssh -o StrictHostKeyChecking=accept-new "$tgt_host-$tgt_node" "$post_cmds"; do
  echo retry post-start
  sleep 1
done
