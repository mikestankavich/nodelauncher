### generated by lxd-tf.py ###

variable lxd_trust_password {
  # lxd host access password passed in from command line
}

variable cloud_init_user_data {
  default = <<EOF
#cloud-config
users:
  - name: nladmin
    shell: /bin/bash
    passwd: REDACTED_HASH
    sudo: [ "ALL=(ALL:ALL) NOPASSWD:ALL" ]
    ssh-authorized-keys:
      - ssh-rsa REDACTED_SSH_PUBLIC_KEY admin@example.com
  - name: zen
    shell: /bin/bash
    passwd: REDACTED_HASH
    ssh-authorized-keys:
      - ssh-rsa REDACTED_SSH_PUBLIC_KEY admin@example.com

packages:
  - python-minimal
EOF
}

# Configure the LXD Provider
provider "lxd" {
  config_dir = "./"
  generate_client_certificates = true
  accept_remote_certificate    = true

  lxd_remote {
    name     = "{{ lxd_host.name }}"
    scheme   = "https"
    address  = "{{ lxd_host.fqdn }}"
    password = "${var.lxd_trust_password}"
  }
}

{% for box in lxd_host.containers %}
resource "lxd_container" "{{ box.name }}" {
  name =  "{{ box.name }}"
  image     = "{{ box.lxd_image | default('zen-base') }}"
  remote = "{{ lxd_host.name }}"
  ephemeral = false

  device {
    name = "eth0"
    type = "nic"
    properties {
      nictype = "macvlan"
      parent  = "{{ lxd_host.nic_device }}"
      hwaddr = "{{ box.mac_address }}"
    }
  }

  config {
    boot.autostart = true
    boot.autostart.delay = {{ (loop.index % 4) * 10 }}
    linux.kernel_modules = "ip_tables,ip6_tables"
    user.network-config = <<EOF
version: 2
ethernets:
  eth0:
    addresses:
    - {{ box.ip_address }}/32 {% if box.ip_address6 %}
    - {{ box.ip_address6 }}/128
    gateway6: {{ lxd_host.gateway6 | default(box.ip_address6) }} {% endif %}
    gateway4: {{ lxd_host.gateway }}
    nameservers:
      addresses:
      - 208.67.222.222
      - 208.67.220.22
      search:
      - nodelauncher.com
      - 4nl.co {% if lxd_host.gateway | default(false) or lxd_host.gateway6 | default(false) %}
    routes: {% endif %} {% if lxd_host.gateway | default(false) %}
    - scope: link
      to: {{ lxd_host.gateway }}
      via: 0.0.0.0 {% endif %} {% if lxd_host.gateway6 | default(false) %}
    - scope: link
      to: {{ lxd_host.gateway6 }}
      via: "::" {% endif %}
EOF
    user.user-data = "${var.cloud_init_user_data}"
  }

  limits {
    cpu.allowance = "{{ box.node_cpu | default(lxd_host.node_cpu) }}"
    memory = "{{ box.node_ram | default(lxd_host.node_ram) }}"
    memory.enforce = "soft"
  }
}
{% endfor %}
